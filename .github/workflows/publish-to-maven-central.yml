name: Publish to mavenCentral

on:
  release:
    types: [released, prereleased]

jobs:
  publish-to-maven-central:
    name: Release build and publish
    runs-on: macOS-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history so we can compare with the last tag

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Identify Last Tag and Changed Modules
        id: changed_modules
        run: |
          # The new tag that triggered the workflow is available in github.ref_name
          LATEST_TAG=${{ github.ref_name }}
          echo "Workflow triggered by tag: $LATEST_TAG"

          # Get the list of all tags sorted by date
          TAG_LIST=$(git tag --sort=-creatordate)

          # Find the previous tag
          PREVIOUS_TAG=$(echo "$TAG_LIST" | sed -n "2p")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found. This is likely the first release."
            # Get the hash of the very first commit in the repository
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            echo "Comparing against the first commit: $FIRST_COMMIT"
            CHANGED_FILES=$(git diff --name-only $LATEST_TAG $FIRST_COMMIT)
          else
            echo "Previous tag is: $PREVIOUS_TAG"
            echo "Comparing $LATEST_TAG vs $PREVIOUS_TAG"
            CHANGED_FILES=$(git diff --name-only $LATEST_TAG $PREVIOUS_TAG)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # List of all modules that can be published
          ALL_MODULES="mvi-core mvi-annotation mvi-android mvi-annotation-processor"

          ASSEMBLE_COMMANDS=""
          PUBLISH_COMMANDS=""
          for MODULE in $ALL_MODULES; do
            # Check if any changed file path contains the module's directory name
            if echo "$CHANGED_FILES" | grep -q "$MODULE/"; then
              echo "$MODULE has changed. Adding to build and publish lists."
              ASSEMBLE_COMMANDS="$ASSEMBLE_COMMANDS :$MODULE:assemble"
              PUBLISH_COMMANDS="$PUBLISH_COMMANDS :$MODULE:publishToMavenCentral"
            else
              echo "$MODULE has NOT changed. Skipping."
            fi
          done

          if [ -z "$PUBLISH_COMMANDS" ]; then
            echo "No changed modules detected. Nothing to build or publish."
          else
            echo "Assemble commands to run: $ASSEMBLE_COMMANDS"
            echo "Publish commands to run: $PUBLISH_COMMANDS"
          fi

          # Set the outputs for the next steps
          echo "assemble_commands=$ASSEMBLE_COMMANDS" >> $GITHUB_OUTPUT
          echo "publish_commands=$PUBLISH_COMMANDS" >> $GITHUB_OUTPUT

      - name: Assemble Changed Modules
        if: steps.changed_modules.outputs.assemble_commands != ''
        run: ./gradlew ${{ steps.changed_modules.outputs.assemble_commands }}

      - name: Publish Changed Modules to MavenCentral
        if: steps.changed_modules.outputs.publish_commands != ''
        run: ./gradlew ${{ steps.changed_modules.outputs.publish_commands }} --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
